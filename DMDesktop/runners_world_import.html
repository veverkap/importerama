<html>
	<head>
		<title>Runners World Import</title>
		<link rel="stylesheet" href="lib/styles/style.css" media="all" type="text/css" />
		<script type="text/javascript" src="lib/air/AIRAliases.js"></script>
		
		<script type="text/javascript" src="lib/air/AIRIntrospector.js"></script> 
		<script type="text/javascript" src="lib/jquery/jquery-1.4.2.js"></script>
		<script type="text/javascript" src="lib/scripts/utils.js"></script>
		
		<script type="text/javascript" src="lib/scripts/chain.js"></script>
		<script type="text/javascript">
			var myFileStream = new air.FileStream();
			var items = new Array();
			function completed(event)
			{ 
				var str = myFileStream.readMultiByte(myFileStream.bytesAvailable, "iso-8859-1");
				parseXml(str);
			} 
			function readFile() {
				var val = $('#xmlFile').val();
				if (val.length > 3) {
					var extension = val.substring(val.length - 3);
					if (extension != "xml") {
						alert('Invalid file type.');
						$('#xmlFile').val("");
					} else {
						//read file
						var myFile = new air.File(); 
						myFile = myFile.resolvePath(val);
						myFileStream.addEventListener(air.Event.COMPLETE, completed);
						myFileStream.openAsync(myFile, air.FileMode.READ); 
					}
				} else {
					alert('Invalid file type.');
					$('#xmlFile').val("");
				}
			}
			function parseXml(data) {
				$(data).find("EventCollection").children().each(function()
				{
					var weather = $(this).find("Weather");
					var item = {
						activityType : parseActivityType(this.nodeName),
						date : $(this).find("Date").text(),
						time : $(this).find("Time").text(),
						type : $(this).find("Type").text(),
						weight : $(this).find("Weight").text(),
						weightUnit : $(this).find("WeightUnit").text(),
						courseName : $(this).find("CourseName").text(),
						distance : $(this).find("Distance").text(),
						distanceUnit : $(this).find("DistanceUnit").text(),
						duration : $(this).find("Duration").text(),
						notes : $(this).find("Notes").text(),
						weather_condition : weather.find("Condition").text(),
						weather_temperature : weather.find("Temperature").text(),
						weather_temperatureunit : weather.find("TemperatureUnit").text()
					}
					
					if (item.activityType != "none") {
						items[items.length] = item;
					}
				});
				  //"Run","Bike","Weights"
				  $('#parsed').items(items).chain(
				/* Custom data binding */
				{
					'.completed_at': {
						id: function(d,el) {
							return 'comments_' + d.id;
						},
						content: function(d,el) {
							return "DUDE";
						}
					}
				});
			}
			
			function parseActivityType(name) {
				name = name.toLowerCase();
				if (name == "run") { return "running"; }
				if (name == "bike") { return "cycling"; }
				if (name == "weights") { return "fitness"; }
				return "none";
			}
		</script>
	</head>
	<body>
		Choose the exported XML file:<br />
		<input id="xmlFile" type="file" style="border: 1px solid #d2d2d2;"/><br />
		<button id="parseBtn" onclick="readFile();">Parse File</button>
		<br />
		<table id="parsed" width="100%">
			<tr>
				<th>activityType</th>
				<th>title</th>
				<th>completed_at</th>
				<th>distance-value</th>
				<th>distance-units</th>
				<th>duration</th>
			</tr>
			<tr id="item">
				<td class="activityType"></td>
				<td class="title"></td>
				<td class="completed_at"></td>
				<td class="distance-value"></td>
				<td class="distance-units"></td>
				<td class="duration"></td>
			</tr>
		</table>
			2010-12-25 12:15:00
			activity_type, completed_at, distance-value, distance-units, duration, title
			activityType, date, time, type, distance, distanceUnitduration : $(this).find("Duration").text(),
						notes : $(this).find("Notes").text(),
						weather_condition : weather.find("Condition").text(),
						weather_temperature : weather.find("Temperature").text(),
						weather_temperatureunit 
	</body>
</html>